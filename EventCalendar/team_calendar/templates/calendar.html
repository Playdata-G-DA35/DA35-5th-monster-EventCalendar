<!DOCTYPE html>
<html>
<head>
    <title>Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .day-cell {
            height: 100px;
            text-align: center;
            vertical-align: top;
            cursor: pointer;
            position: relative;
            width : 185px;
        }
        .selected {
            background-color: #f8d7da !important;
        }
        .schedule-item {
            margin-top: 5px;
            font-size: 12px;
            display: flex;
            justify-content: space-evenly;
        }
        .sunday {
            color: red !important;
        }

        .saturday{
            color: blue !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-light">
        <div class="container">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="/" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="{%url 'team_calendar:team_list'%}" class="nav-link">팀목록</a>
                </li>
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a href="{% url 'team_calendar:create_team'%}" class="nav-link">팀등록</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'account:logout'%}" class="nav-link">로그아웃</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'account:detail' %}" class="nav-link"><b>{{user.name}} 님</b></a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a href="{% url 'account:join'%}" class="nav-link">가입</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'account:login'%}" class="nav-link">로그인</a>
                    </li>
                {% endif %}
                
            </ul>
        </div>
    </nav>
<div class="container">
    <form method="get" action="">
        <div class="row mb-3">
            <div class="col-md-3">
                <select name="year" class="form-select" id="yearSelect">
                    {% for year in years %}
                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="month" class="form-select" id="monthSelect">
                    {% for month in months %}
                    <option value="{{ month }}" {% if month == current_month %}selected{% endif %}>{{ month }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">보기</button>
            </div>
        </div>
    </form>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th class="sunday">Sun</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th class="saturday">Sat</th>
        </tr>
        </thead>
        <tbody>
        {% for week in calendar %}
        <tr>
            {% for day in week %}
            <td class="day-cell" data-day="{{ day }}">
                {% if day != 0 %}
                <div class="{% if forloop.counter0 == 0 %}sunday{% elif forloop.counter0 == 6 %}saturday{% endif %}">
                    {{ day }}
                </div>
                {% else %}
                    <div class="inactive"></div>
                {% endif %}
                {% for key, values in schedules %}
                    {% if day == key%}
                        {%for schedule in values %}
                    <div class="schedule-item">
                        <br> {{schedule.user_name}} : {{ schedule.start_time }}~{{ schedule.end_time }} <br>사유:{{schedule.memo}}
                        
                    </span>
                        {% if schedule.is_user_schedule %}
                            <form method="post" action="{% url 'team_calendar:delete_schedule' schedule.id %}" style="display: inline;" onsubmit="updateYearMonth()">
                                {% csrf_token %}
                                <input type="hidden" id="year" name="year" value="{{ current_year }}">
                                <input type="hidden" id="month" name="month" value="{{ current_month }}">
                                <button type="submit" class="btn-close" aria-label="Close"></button>
                            </form>
                        {% endif %}
                    </div>
                    {% endfor%}
                    {% endif %}
                {% endfor %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<!-- Modal -->
<div class="modal fade" id="timeModal" tabindex="-1" aria-labelledby="timeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="timeForm"  method="post" action="{% url 'team_calendar:calendar_view' %}" >
                <div class="modal-header">
                    <h5 class="modal-title" id="timeModalLabel">시간 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Start Time:</label>
                        <select id="start_time" name="start_time" class="form-select">
                            {% for minute in minutes %}
                            <option value="{{ minute }}">{{ minute }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="end_time" class="form-label">End Time:</label>
                        <select id="end_time" name="end_time" class="form-select">
                            {% for minute in minutes %}
                            <option value="{{ minute }}">{{ minute }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="memo" class="form-label">메모:</label>
                        <input type="text" id="memo" name="memo" class="form-control" placeholder="메모를 입력하세요">
                    </div>
                    <input type="hidden" id="selected_day" name="selected_day">
                    <input type="hidden" id="year" name="year" value="{{ current_year }}">
                    <input type="hidden" id="month" name="month" value="{{ current_month }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.day-cell').forEach(function(day) {
        day.addEventListener('click', function() {
            if (this.dataset.day !== "0")
            var modal = new bootstrap.Modal(document.getElementById('timeModal'));
            document.getElementById('selected_day').value = this.dataset.day;
            document.getElementById('year').value = document.getElementById('yearSelect').value;
            document.getElementById('month').value = document.getElementById('monthSelect').value;
            modal.show();
        });
    });
    function updateYearMonth() {
            document.getElementById('year').value = document.getElementById('yearSelect').value;
            document.getElementById('month').value = document.getElementById('monthSelect').value;
        }
    
    document.getElementById("timeForm").onsubmit = function(event) {
    event.preventDefault(); // Prevent form from submitting normally
    if (time_valid()) {
        this.submit(); // Submit the form if validation passes
    }
};

    function time_valid(){
        var start_time = document.getElementById('start_time').value;
        var end_time = document.getElementById('end_time').value;
        if(start_time >= end_time){
            alert("시간 설정을 확인해 주세요.");
            return false;
        }
        else {
            console.log('sdsd')
        return true;
        }
    }
</script>
</body>
</html>